---
services:

  clickhouse:
    image: clickhouse/clickhouse-server:24.8
    container_name: clickhouse
    environment:
      CLICKHOUSE_DB: xrpl
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: "1"
      CLICKHOUSE_USER: katz
      CLICKHOUSE_PASSWORD: katz-password
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    ports:
      - "9000:9000"   # native
      - "8123:8123"   # http
    volumes:
      - clickhouse-data:/var/lib/clickhouse
    healthcheck:
      test: ["CMD-SHELL", "clickhouse-client --user=katz --password=katz-password --query='SELECT 1'"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s
      

  clickhouse-init:
    image: clickhouse/clickhouse-server:24.8
    container_name: clickhouse-init
    depends_on:
      clickhouse:
        condition: service_healthy
    volumes:
      - ./clickhouse/ddl:/ddl:ro
    entrypoint: /bin/sh
    command: -c "for f in /ddl/*.sql; do echo Running $$f; clickhouse-client --host 51.250.120.186 --user=katz --password=katz-password --multiquery < $$f; done"
    restart: "no"

volumes:
  clickhouse-data:
    driver: local
