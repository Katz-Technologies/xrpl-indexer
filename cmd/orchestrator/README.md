# Backfill Orchestrator

Оркестратор для управления параллельным бэкфиллингом леджеров XRPL с автоматическим перераспределением работы и заполнением пропусков.

## Возможности

- **Параллельный бэкфиллинг**: Запускает N процессов бэкфиллинга одновременно
- **Распределение по нодам**: Автоматически распределяет процессы между разными XRPL нодами (round-robin)
- **Автоматическое перераспределение**: При завершении одного процесса останавливает остальные и перераспределяет оставшуюся работу
- **Заполнение пропусков**: Автоматически находит и заполняет пропущенные леджеры один раз за цикл
- **Graceful shutdown**: Корректно останавливает все процессы при завершении

## Использование

### Сборка

```bash
make build
```

Это создаст исполняемый файл `bin/platform-orchestrator`.

### Запуск

```bash
./bin/platform-orchestrator \
  --workers 4 \
  --from 82000000 \
  --to 85000000 \
  --servers "wss://s1.ripple.com/,wss://s2.ripple.com/,wss://xrplcluster.com/" \
  --check-interval 30s \
  --config .env \
  --cli-path ./bin/platform-cli \
  --verbose
```

### Параметры

- `--workers` (по умолчанию: 2) - Количество параллельных процессов бэкфиллинга
- `--from` (по умолчанию: 82000000) - Начальный индекс леджера
- `--to` (по умолчанию: 82001000) - Конечный индекс леджера
- `--servers` - Список XRPL серверов через запятую
- `--check-interval` (по умолчанию: 30s) - Интервал проверки статуса процессов
- `--config` (по умолчанию: .env) - Файл конфигурации
- `--cli-path` (по умолчанию: ./bin/platform-cli) - Путь к исполняемому файлу platform-cli
- `--verbose` - Включить подробное логирование
- `--delay` (по умолчанию: 100) - Минимальная задержка между запросами (мс)

## Как это работает

1. **Запуск**: Оркестратор делит диапазон леджеров на N частей и запускает N процессов бэкфиллинга, распределяя их по разным XRPL нодам.

2. **Мониторинг**: Оркестратор периодически проверяет статус всех процессов.

3. **Завершение процесса**: Когда один из процессов завершается:
   - Останавливаются все остальные процессы
   - Выполняется заполнение пропусков (один раз за цикл)
   - Вычисляется оставшийся диапазон леджеров
   - Работа перераспределяется между N процессами
   - Запускается новая итерация

4. **Заполнение пропусков**: 
   - Оркестратор запрашивает ClickHouse для определения пропущенных леджеров
   - Группирует последовательные пропуски в диапазоны
   - Пытается заполнить пропуски (до 10 диапазонов за цикл)
   - Не ждет успешного заполнения всех пропусков - некоторые леджеры могут быть намеренно пропущены (не содержат Payment транзакций)

5. **Завершение**: Когда все леджеры в диапазоне обработаны, оркестратор завершает работу.

## Логи

Каждый worker процесс пишет логи в отдельный файл:
- `logs/backfill-worker-1.log`
- `logs/backfill-worker-2.log`
- и т.д.

Логи оркестратора выводятся в stdout/stderr (обычно перенаправляются в `logs/backfill-orchestrator.log`).

## Примеры

### Базовый запуск с 2 процессами

```bash
./bin/platform-orchestrator --workers 2 --from 82000000 --to 82010000
```

### Запуск с 4 процессами и 3 нодами

```bash
./bin/platform-orchestrator \
  --workers 4 \
  --from 82000000 \
  --to 85000000 \
  --servers "wss://s1.ripple.com/,wss://s2.ripple.com/,wss://xrplcluster.com/"
```

### Запуск с кастомным интервалом проверки

```bash
./bin/platform-orchestrator \
  --workers 3 \
  --from 82000000 \
  --to 83000000 \
  --check-interval 1m
```

## Примечания

- Оркестратор использует ClickHouse для определения прогресса и пропусков
- Некоторые леджеры могут быть намеренно пропущены, если они не содержат Payment транзакций
- Заполнение пропусков выполняется только один раз за цикл перезапуска
- При заполнении пропусков обрабатывается максимум 10 диапазонов за цикл, чтобы не тратить слишком много времени

